<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>镜缘浮影</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
    <script src="/javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
      <h1><a href="http://soft.dog/">镜缘浮影</a></h1>
        <p>小人本住在 苏州的城外 家里有屋又有田 生活乐无边</p>
        <p class="view"><a href="http://soft.dog/">Back to home </a></p>
        <ul>
          <li><a href="http://soft.dog/">Back To <strong>Home</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="welcome-to-github-pages" class="anchor" href="#welcome-to-github-pages"><span class="octicon octicon-link"></span></a> 测试文档 
        </h1>
<ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">如何创建一个线程</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">结束线程</a></li>
  <li><a href="#wait--sleep" id="markdown-toc-wait--sleep">wait 与 sleep</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">线程池</a>    <ul>
      <li><a href="#section-3" id="markdown-toc-section-3">好处</a></li>
      <li><a href="#section-4" id="markdown-toc-section-4">使用</a></li>
      <li><a href="#section-5" id="markdown-toc-section-5">原理</a></li>
    </ul>
  </li>
</ul>

<h2 id="section">如何创建一个线程</h2>

<p>按 Java 语言规范中的说法，创建线程只有一种方式，就是创建一个 Thread 对象。而从 HotSpot 虚拟机的角度看，创建一个虚拟机线程
有两种方式，一种是创建 Thread 对象，另一种是创建 一个本地线程，加入到虚拟机线程中。</p>

<p>如果从 Java 语法的角度。有两种方法。</p>

<p>第一是继承 Thread 类，实现 run 方法，并创建子类对象。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="c">#</span>
<span class="c"># This script will be executed *after* all the other init scripts.</span>
<span class="c"># You can put your own initialization stuff in here if you don&#39;t</span>
<span class="c"># want to do the full Sys V style init stuff.</span>

touch /var/lock/subsys/local



        public void startThreadUseSubClass<span class="o">()</span> <span class="o">{</span>
                class MyThread extends Thread <span class="o">{</span>
                        public void run<span class="o">()</span> <span class="o">{</span>
                                System.out.println<span class="o">(</span><span class="s2">&quot;start thread using Subclass of Thread&quot;</span><span class="o">)</span><span class="p">;</span>
                        <span class="o">}</span>
                <span class="o">}</span>

                MyThread <span class="nv">thread</span> <span class="o">=</span> new MyThread<span class="o">()</span><span class="p">;</span>
                thread.start<span class="o">()</span><span class="p">;</span>
        <span class="o">}</span></code></pre></div>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">ruby
	public void startThreadUseSubClass<span class="o">()</span> <span class="o">{</span>
		class MyThread extends Thread <span class="o">{</span>
			public void run<span class="o">()</span> <span class="o">{</span>
				System.out.println<span class="o">(</span><span class="s2">&quot;start thread using Subclass of Thread&quot;</span><span class="o">)</span><span class="p">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		MyThread <span class="nv">thread</span> <span class="o">=</span> new MyThread<span class="o">()</span><span class="p">;</span>
		thread.start<span class="o">()</span><span class="p">;</span>
	<span class="o">}</span></code></pre></div>

<p>另一种是传递给 Thread 构造函数一个 Runnable 对象。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">java
	public void startThreadUseRunnalbe<span class="o">()</span> <span class="o">{</span>
		Thread <span class="nv">thread</span> <span class="o">=</span> new Thread<span class="o">(</span>new Runnable<span class="o">()</span> <span class="o">{</span>
			public void run<span class="o">()</span> <span class="o">{</span>
				System.out.println<span class="o">(</span><span class="s2">&quot;start thread using runnable&quot;</span><span class="o">)</span><span class="p">;</span>
			<span class="o">}</span>
		<span class="o">})</span><span class="p">;</span>
		thread.start<span class="o">()</span><span class="p">;</span>
	<span class="o">}</span></code></pre></div>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="c"># </span>
<span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="nv">$ </span>
<span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="nv">$ </span>ls
2015-04-02-Redis-install.md  orbit-gituser                               pulse-EtjTZIcBzsAZ  txt          vmware-root-735807556
aa                           percona-version-check                       pulse-iCVqts8hgSdG  VMwareDnD
fuck.md                      percona-xtrabackup-2.2.12-1.el6.x86_64.rpm  pulse-UgVRM05kXEt0  vmware-root
<span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="c"># ls</span>
2015-04-02-Redis-install.md  orbit-gituser                               pulse-EtjTZIcBzsAZ  txt          vmware-root-735807556
aa                           percona-version-check                       pulse-iCVqts8hgSdG  VMwareDnD
fuck.md                      percona-xtrabackup-2.2.12-1.el6.x86_64.rpm  pulse-UgVRM05kXEt0  vmware-root
<span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="c"># cat /etc/resolv.conf </span>
<span class="p">;</span> generated by /sbin/dhclient-script
nameserver 192.168.0.210
<span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="c"># cat /etc/rc.local </span>
<span class="c">#!/bin/sh</span>
<span class="c">#</span>
<span class="c"># This script will be executed *after* all the other init scripts.</span>
<span class="c"># You can put your own initialization stuff in here if you don&#39;t</span>
<span class="c"># want to do the full Sys V style init stuff.</span>

touch /var/lock/subsys/local
<span class="o">[</span>gituser@tools tmp<span class="o">]</span><span class="err">$</span></code></pre></div>

<p>当然， Runnalbe 对象，也不是只有这一种形式，例如如果我们想要线程执行时返回一个值，就需要用到另一种 Runnalbe 对象，它
对原来的 Runnalbe 对象进行了包装。</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">java
	public void startFutureTask<span class="o">()</span> <span class="o">{</span>
		FutureTask&lt;Integer&gt; <span class="nv">task</span> <span class="o">=</span> new FutureTask&lt;&gt;<span class="o">(</span>new Callable&lt;Integer&gt;<span class="o">()</span> <span class="o">{</span>
			public Integer call<span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> 1<span class="p">;</span>
			<span class="o">}</span>
		<span class="o">})</span><span class="p">;</span>

		new Thread<span class="o">(</span>task<span class="o">)</span>.start<span class="o">()</span><span class="p">;</span>

		try <span class="o">{</span>
			Integer <span class="nv">result</span> <span class="o">=</span> task.get<span class="o">()</span><span class="p">;</span>
			System.out.println<span class="o">(</span><span class="s2">&quot;future result &quot;</span> + result<span class="o">)</span><span class="p">;</span>
		<span class="o">}</span> catch <span class="o">(</span>InterruptedException e<span class="o">)</span> <span class="o">{</span>
			e.printStackTrace<span class="o">()</span><span class="p">;</span>
		<span class="o">}</span> catch <span class="o">(</span>ExecutionException e<span class="o">)</span> <span class="o">{</span>
			e.printStackTrace<span class="o">()</span><span class="p">;</span>
		<span class="o">}</span>
	<span class="o">}</span></code></pre></div>

<h2 id="section-1">结束线程</h2>

<h2 id="wait--sleep">wait 与 sleep</h2>

<p>sleep 会使得当前线程休眠一段时间，但并不会释放已经得到的锁。</p>

<p>wait 会阻塞住，并释放已经得到的锁。一直到有人调用 notify 或者 notifyAll，它会重新尝试得到锁，然后再唤醒。</p>

<h2 id="section-2">线程池</h2>

<h3 id="section-3">好处</h3>

<ul>
  <li>复用</li>
</ul>

<p>线程池中有一系列线程，这些线程在执行完任务后，并不会被销毁，而会从任务队列中取出任务，执行这些任务。这样，就避免为每个任务
都创建线程，销毁线程。 在有大量短命线程的场景下，如果创建线程和销毁线程的时间比线程执行任务的时间还长，显然是不划算的，这时候，使用线程池就会有明显
的好处。</p>

<ul>
  <li>流控</li>
</ul>

<p>同时，可以设置线程数目，这样，线程不会增大到影响系统整体性能的程度。当任务太多时，可以在队列中排队，
如果有空闲线程，他们会从队列中取出任务执行。</p>

<h3 id="section-4">使用</h3>

<ul>
  <li>线程数目</li>
</ul>

<p>那么，线程的数目要设置成多少呢？这需要根据任务类型的不同来设置，假如是大量计算型的任务，他们不会阻塞，那么可以将线程数目设置
为处理器数目。而如果任务中涉及大量IO，有些线程会阻塞住，这样就要根据阻塞线程数目与运行线程数目的比例，以及处理器数目来设置
线程总数目。例如阻塞线程数目与运行线程数目之比为n, 处理器数目为p，那么可以设置 n * (p + 1) 个线程，保证有 n 个线程处于运行
状态。</p>

<ul>
  <li>Executors</li>
</ul>

<p>JDK 的 java.util.concurrent.Executors 类提供了几个静态的方法，用于创建不同类型的线程池。</p>

<div class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
	<span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;()</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="n">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
	<span class="o">});</span>
	<span class="n">results</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
<span class="o">}</span></code></pre></div>

<p><code>newFixedThreadPool</code> 可以创建固定数目的线程，一旦创建不会自动销毁线程，即便长期没有任务。除非显式关闭线程池。如果任务队列中有任务，就取出任务执行。</p>

<p>另外，还可以使用 <code>newCachedThreadPool</code> 方法创建一个不设定固定线程数目的线程池，它有一个特性，线程完成任务后，如果一分钟之内又有新任务，就会复用这个线程执行新任务。如果超过一分钟还没有任务执行，就会自动销毁。</p>

<p>另外，还提供了 <code>newSingleThreadExecutor</code> 创建有一个工作线程的线程池。</p>

<h3 id="section-5">原理</h3>

<p>JDK 中的线程池通过 HashSet 存储工作者线程，通过 BlockingQueue 来存储待处理任务。</p>

<p>通过核心工作者数目(corePoolSize) 和 最大工作者数目(maximumPoolSize) 来确定如何处理任务。如果当前工作者线程数目
小于核心工作者数目，则创建一个工作者线程执行这个任务。否则，将这个任务放入待处理队列。如果入队失败，再看看当前工作
者数目是不是小于最大工作者数目，如果小于，则创建工作者线程执行这个任务。否则，拒绝执行这个任务。</p>

<p>另外，如果待处理队列中没有任务要处理，并且工作者线程数目超过了核心工作者数目，那么，需要减少工作者线程数目。</p>

      </section>
      
      <section class="comments">
        
          <div id="disqus_thread"></div>
 <script type="text/javascript">
     /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
     var disqus_shortname = 'wilmosfang'; // required: replace example with your forum shortname

     /* * * DON'T EDIT BELOW THIS LINE * * */
     (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
 </script>
 <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    

        
      </section>
    </div>
    <footer>
      <p>Blog maintained by <strong>wilmosfang</strong></p>
      <p><a href="http://soft.dog/">Back to Home</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
