---
layout: post
title: 浅析NAT工作原理
categories: 路由器
excerpt: NAT原理
comments: true
---

计算机都必须有一个IP地址（公址Public IP），才能和Internet网络上其他设备正确通信。公址Public IP,在某个时刻必须是唯一的。

我们局域网的所有电脑均能上网，同时上也没有问题，究竟又是怎么实现的？这就要说到我们今天学习的NAT。

书上的定义：NAT网络地址转换(NAT,Network Address Translation)属接入广域网(WAN)技术,是一种将私有(保留)地址转化为合法IP地址的转换技术,它被广泛应用于各种类型Internet接入方式和各种类型的网络中。原因很简单，NAT不仅完美地解决了lP地址不足的问题，而且还能够有效地避免来自网络外部的攻击，隐藏并保护网络内部的计算机。

NAT的实现方式有三种，即静态转换Static Nat、动态转换Dynamic Nat 和 端口多路复用OverLoad。
- **静态转换**（一对一）
　　静态转换是指将内部网络的私有IP地址转换为公有IP地址，IP地址对是一对一的，是一成不变的，某个私有IP地址只转换为某个公有IP地址。私有地址和公有地址的对应关系由管理员手工指定。借助于静态转换，可以实现外部网络对内部网络中某些特定设备（如服务器）的访问，并使该设备在外部用户看来变得“不透明”。

- **动态转换**（多对多）
　　动态转换是指将内部网络的私有IP地址转换为公用IP地址时，IP地址对并不是一一对应的，而是随机的。所有被管理员授权访问外网的私有IP地 址可随机转换为任何指定的公有IP地址。也就是说，只要指定哪些内部地址可以进行转换，以及用哪些合法地址作为外部地址时，就可以进行动态转换。每个地址 的租用时间都有限制。这样，当ISP提供的合法IP地址略少于网络内部的计算机数量时，可以采用动态转换的方式。


- **端口多路复用**（多对一）
　　通过使用端口多路复用，可以达到一个公网地址对应多个私有地址的一对多转换。在这种工作方式下，内部网络的所有主机均可共享一个合法外部IP地 址实现对Internet的访问，来自不同内部主机的流量用不同的随机端口进行标示，从而可以最大限度地节约IP地址资源。同时，又可隐藏网络内部的所有 主机，有效避免来自internet的攻击。因此，目前网络中应用最多的就是端口多路复用方式。


搞懂了其中端口多路复用OverLoad，你就能理解理解局域网中电脑几台同时均能上网的问题了。

我们的计算机和外网通信，一定是电脑里有一个应用程序在运行，比如说IE浏览器。这个应用程序能够和外界Internet网 通信，必须在本计算机上打开一个或几个端口；同样当他浏览某个网站的某个网页时，也必须通过网站服务器中的一个或几个端口才能复制网页内容再按原路传送过 来，我们的浏览器将他显示在我们的屏幕上。这就是我们运用浏览器浏览网页的过程。从上面的过程我们可以知道，网络设备间通信不仅要有Public IP（我的计算机和网站服务器的），而且要有各自端口号才能完成相互的通讯。即：IP+端口号

端口是什么？端口包括物理端口和逻辑端口。物理端口是用于连接物理设备之间的接口，逻辑端口是逻辑上用于区分服务的端口。TCP/IP协议中的端口就是逻辑端口，通过不同的逻辑端口来区分不同的服务。
端口有什么用呢？我们知道，一台拥有IP地址的主机可以提供许多服务，比如Web服务、FTP服务、SMTP服务等，这些服务完全可以通过1个IP地址来实现。那么，主机是怎样区分不同的网络服务呢？显然不能只靠IP地址，因为IP 地址与网络服务的关系是一对多的关系。实际上是通过“IP地址+端口号”来区分不同的服务的。

---          
            
我们现在以一个IE浏览器浏览新浪首页实例来说明NAT工作原理：

- 假设我们局域网中的一台电脑A(192.168.1.100),打开了IE浏览器，IE浏览器程序运行后，打开本机的11111端口（这个端口是随机的，系统动态产生），我想浏览新浪首页，就在地址栏输入www.sina.com.cn,即我要访问www.sina.com.cn，www.sina.com.cn就是60.215.128.246:80（这里面涉及到DNS，不是本篇重点，说明省略），此时我的电脑A就向内网（局域网）发一个数据包，这个数据包不仅有数据（即我想干什么——浏览网页），还包括一类重要的信息—源地址和目标地址。源地址就是表明数据包时由谁发出的，源地址由IP和端口两部分组成，我们这就是192.168.1.100:11111；目标地址表明此数据包要送到什么地方去，或者理解为要与谁通信，它也是由IP和端口两部分组成，我们这就是60.215.128.246:80，数据包依着路由表发出，NAT设备的计算机（本例为192.168.1.1）收到此数据包会有响应。
（NAT设备一般是路由器，路由器至少有一个WAN口和一个LAN口，LAN口连接的是私址（PRIVITE IP）类型，我们这为(192.168.1.1)；WAN口连接的是公址（PUBLIC IP）类型，我们这为(122.195.93.74)。他把局域网和外网联系起来，并完成内外网地址（IP+端口）的映射工作）

- NAT设备会根据数据包中的目标地址，把这个数据包送到目标地址60.215.128.246:80—新浪网站（WEB服务器），但在送出此数据包之前，他对此数据包进行了修改：把此数据包的源地址由192.168.1.100:11111改为122.195.93.74:22222，这个过程就是NAT。数据包的目标地址不变。同时，会在自身更新NAT TABLE。此时两者建立的关系是映射，即一一对应，在不中断IE浏览器程序运行，这种关系一直保持。此时如果你又打开搜狐网页，就又会增加建立一个映射，如192.168.1.100：11212——122.195.93.74：22223。从上我们可以看到，无论是IE浏览器程序开的端口，如本例中11111，还是NAT设备的映射端口本例中22222，都是随机的，但一旦建立，他们必须是一一对应的映射关系，而且不会被其他程序再使用！

- 新浪网站（WEB服务器）—60.215.128.246:80口运行的程序收到此数据包以后，处理分析得知，要把本站某网页内容复制后再发到122.195.93.74:22222（注意这是我们的NAT计算机），就打包数据发送。这个数据包也有源地址和目标地址，源地址60.215.128.246:80（新浪），目标地址122.195.93.74:22222（我们的NAT设备）。

- 很快NAT设备就收到到此包了，NAT设备查看数据包会依据NAT TABLE，把此数据包的目标地址从122.195.93.74:22222改为192.168.1.100:11111，这个过程也是NAT，源地址不变，为新浪网址60.215.128.246:80。
- 修改后将数据包向内网发出，我的这台局域网中的电脑A，更确切的说我的电脑运行着的IE浏览器程序就能收到他要的外网数据，处理以后就在我的显示器上将新浪网页显示出来。

---

至此完成我们内网电脑通过NAT设备和外网设备一次完整的通讯，这个过程中地址改过两次，也就是说NAT两次：在我内网计算机上传的过程中，数据包的源地址改过一次，目标地址一直保持不变；下传过程中相反。

类似的，我们局域网中的计算机B要访问外网，过程和上相似，NAT设备会提供另外一个未用的端口给局域网中的计算机B。只要NAT设备能提供不同的端口（NAT设备可提供上万个端口），就可以让内网计算机和外网通讯（俗称上网），并且能让数台内网计算机互不影响地同时上网。
